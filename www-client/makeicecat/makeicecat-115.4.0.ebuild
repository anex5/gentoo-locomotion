# Copyright 2021-2023 Gentoo Authors
# Distributed under the terms of the GNU General Public License v2

EAPI=8

PYTHON_COMPAT=( python3_{10..12} )

inherit python-any-r1

DESCRIPTION="Script for creating GNU Icecat tarball"
HOMEPAGE="https://www.gnu.org/software/gnuzilla/"

COMMIT="5b2ce0c4cefc73f996f260edfac368ecc3d86b24"
COMPARE_LOCALES_PV="9.0.1"
SRC_URI="
	https://git.savannah.gnu.org/cgit/gnuzilla.git/snapshot/gnuzilla-${COMMIT}.tar.gz
	https://archive.mozilla.org/pub/firefox/releases/${PV}esr/source/firefox-${PV}esr.source.tar.xz
	https://github.com/mozilla/compare-locales/archive/refs/tags/RELEASE_${COMPARE_LOCALES_PV//./_}.tar.gz
		-> compare-locales-${COMPARE_LOCALES_PV}.tar.gz
"

LICENSE="GPL-3"
SLOT="${PV}"
KEYWORDS="~amd64"

RESTRICT="test mirror"

IUSE="+buildtarball"

RDEPEND="${BDEPEND}"
BDEPEND="
	${PYTHON_DEPS}
	app-arch/unzip
	app-crypt/gnupg
	dev-vcs/mercurial
	$(python_gen_any_dep '
		dev-python/jsonschema[${PYTHON_USEDEP}]
	')
"

S="${WORKDIR}/gnuzilla-${COMMIT}"

declare -A LANG_COMMIT

LANG_COMMIT[ace]="844c9b53019ae24904a75347fee1faa1bf7ebdef" # 2023-08-05 12:49
LANG_COMMIT[ach]="5650a9b26f2cc2eacc711f69776ebc755d4743c0" # 2023-10-02 16:42
LANG_COMMIT[af]="05038f7f1f36ff6713eb849d8cfd6753b8ea6d94" # 2023-08-31 08:54
LANG_COMMIT[ak]="035ea4b91a765342ec3d37b5ecb8f89ae8342887" # 2023-08-31 08:54
LANG_COMMIT[an]="f7182a3eeca7987a863044e0269db1f36be2aa15" # 2023-10-02 16:43
LANG_COMMIT[ar]="38f4694aba252db6bc08f5fa7141236f24774782" # 2023-10-02 16:43
LANG_COMMIT[as]="d183bd156f257088bf80002d28b713e90501dbcb" # 2023-09-27 06:44
LANG_COMMIT[ast]="54c0fc7d0153d6bdb754b993a59654e20d498ad7" # 2023-10-02 16:43
LANG_COMMIT[az]="6f019af65d763726553e4671e224a024b2389970" # 2023-09-06 08:03
LANG_COMMIT[be]="ef0198be89cf5917f974e3c9a831991888d6cb1f" # 2023-10-10 16:54
LANG_COMMIT[bg]="4c91ce62f50c52c6daa3aac0858861aa10af7eec" # 2023-10-02 16:43
LANG_COMMIT[bn]="acc7c7fe6d0597a265d669c009694253d378e398" # 2023-10-02 16:43
LANG_COMMIT[bn-BD]="afcbee6a0c316e31e46d960fa4eeb410125f820d" # 2023-08-31 08:55
LANG_COMMIT[bn-IN]="5bb3623ed4036acd76b1a55058113bbf62bb3303" # 2023-08-31 08:55
LANG_COMMIT[bo]="42f95ae54a242d1a49621d4786224af77cdca739" # 2023-08-05 12:52
LANG_COMMIT[br]="9c22e7a56318bd63313d9d8c77dd05520683da9d" # 2023-10-02 16:43
LANG_COMMIT[brx]="4f6b12102e7b1fc9770740db17adbb742c1dbced" # 2023-09-06 08:04
LANG_COMMIT[bs]="f70bbfdc3a339a4cd4f5a7aa4b8d4983f042e6f4" # 2023-09-06 08:04
LANG_COMMIT[ca]="75c41575322a61e283fae49c6b6f850cc3341bf0" # 2023-10-02 16:44
LANG_COMMIT[ca-valencia]="cab01ade5e18e97185f8923d58080071b3f64a9f" # 2023-10-02 16:44
LANG_COMMIT[cak]="eda02e29de6fbbd32450644b85159962c3dfea14" # 2023-10-02 16:44
LANG_COMMIT[ckb]="731d194095a7619e5fe5f92772bb3f84b1efdc62" # 2023-10-02 16:44
LANG_COMMIT[crh]="9d310a0f7338f832a08051d44330f38281d83306" # 2023-09-06 08:05
LANG_COMMIT[cs]="4df3c49d0bfd3b90fad73630bc060a483dbebc1b" # 2023-10-11 20:43
LANG_COMMIT[csb]="39b9f449fc716b8566f694b0f76a415246571411" # 2023-08-31 08:56
LANG_COMMIT[cy]="1f28d0f7707a22aa1d0f1373be207b0e2a19a45b" # 2023-10-10 11:27
LANG_COMMIT[da]="801762d1e865492507d5eb694e7e2ba2030aa88e" # 2023-10-13 14:24
LANG_COMMIT[de]="e72869345d2708a98d135ae828607f9083279db6" # 2023-10-12 08:10
LANG_COMMIT[dsb]="6c9b74961a0237c0f23f505221a6f163c70bd54e" # 2023-10-10 19:35
LANG_COMMIT[el]="a85f46c10a445226a79a5262ca75c31ddd08274c" # 2023-10-14 02:10
LANG_COMMIT[en-CA]="d4e721e8864c2fd37e1a1b10994e1080b207838b" # 2023-10-10 12:43
LANG_COMMIT[en-GB]="983b7fc1c458d85ca2246cb21c7e0a9372ced0dd" # 2023-10-11 22:14
LANG_COMMIT[en-ZA]="f6d943566bf79984745d996f46b4622bb72cd1b3" # 2023-08-31 08:57
LANG_COMMIT[eo]="270a0537e299a334d4a2020087eca3b954e30a7a" # 2023-10-09 16:56
LANG_COMMIT[es-AR]="c17379fe3fc65a426934db9b3f403fc0d5cd9914" # 2023-10-10 05:54
LANG_COMMIT[es-CL]="708b7a02608cc4ebc1b34abfc3b14a6ce3881918" # 2023-10-11 15:24
LANG_COMMIT[es-ES]="e9c910595abc4d68d3353f0bef783fa25a39ccd9" # 2023-10-09 16:56
LANG_COMMIT[es-MX]="212b1fc0517416eea6d5a12c741abf31de5d3f0e" # 2023-10-02 16:45
LANG_COMMIT[et]="6e60a47a1bca17efa8f7694f78d228af2c2f2980" # 2023-10-02 16:45
LANG_COMMIT[eu]="5872b3baf0caedc422bf0725b003c2963aacd448" # 2023-10-09 16:56
LANG_COMMIT[fa]="3101a0c1133bb909224034b103c5a5e03ccf7e0c" # 2023-10-02 16:45
LANG_COMMIT[ff]="18eab110853900e3bc698e9e0273c2dae03c0c43" # 2023-09-06 08:08
LANG_COMMIT[fi]="b57082c23fed4221653bdbb90239d5d6fce0c09b" # 2023-10-12 13:06
LANG_COMMIT[fr]="2c2b6835e611de336c22e3887e7d5f1a9d3bf28e" # 2023-10-12 09:53
LANG_COMMIT[frp]="3c5b9926ffb44324a4b5f33225870b778032a37d" # 2023-08-05 12:58
LANG_COMMIT[fur]="7fd6c54d01e9ac336ce6c09dc943d31792523261" # 2023-10-13 15:34
LANG_COMMIT[fy-NL]="aaa46bcd9cd9460cc58422aea109cb0c394605b8" # 2023-10-10 13:05
LANG_COMMIT[ga-IE]="87dcf2b09a5c652e1f6364bc8a94eace943b0efa" # 2023-09-06 08:09
LANG_COMMIT[gd]="2d9b249512ecb190ec76a41dff8b7f7af4cbca25" # 2023-10-02 16:46
LANG_COMMIT[gl]="2f07c08bf310f007cbc5da47569640fbf8429990" # 2023-10-09 16:57
LANG_COMMIT[gn]="0fa7f55ed6790d99b8af40e2dfafd02a4f422991" # 2023-10-13 17:34
LANG_COMMIT[gu-IN]="7b7a4ffeee73f469715776f4d87ccbae97880a22" # 2023-09-06 08:10
LANG_COMMIT[gv]="025c6cac9fe0191b1713087655945a0554d3a69f" # 2023-07-06 08:39
LANG_COMMIT[he]="21494472c9e94f59dbdf3b64a3e860914784bd53" # 2023-10-10 13:23
LANG_COMMIT[hi-IN]="f847db630c096c62359fe5b350fa86bcd633c4f2" # 2023-10-02 16:46
LANG_COMMIT[hr]="2864f4405b91d0061ec59530508443f5079fc16e" # 2023-10-02 16:46
LANG_COMMIT[hsb]="41292dabca672049b111529a6e43d6d334e70b74" # 2023-10-10 20:54
LANG_COMMIT[hto]="c576818ee3fedf88bf91ea07b66d47951c5d0701" # 2023-08-31 09:01
LANG_COMMIT[hu]="6e2b118c75b97b54a45d7e728393084a30c40394" # 2023-10-10 09:10
LANG_COMMIT[hy-AM]="6df5669dafae4458baa0da068849d1226d77786f" # 2023-10-13 15:54
LANG_COMMIT[hye]="2948e53baa6438a7b553fe7743e6e37a617b7abf" # 2023-10-02 16:47
LANG_COMMIT[ia]="278ffacad10965be4e0b110b37339a6e90fa3d12" # 2023-10-10 15:43
LANG_COMMIT[id]="def0e7349205db034ccb177507366439a08edc26" # 2023-10-02 16:47
LANG_COMMIT[ilo]="32cb92f75a596d0092c463cdeee23a8b7a986820" # 2023-08-31 09:01
LANG_COMMIT[is]="6c2f02b64e9631179764ad8e232292cef5d765c8" # 2023-10-10 15:53
LANG_COMMIT[it]="a70761250de8ab91fff40be16c613a617711adf4" # 2023-10-12 11:39
LANG_COMMIT[ixl]="e5b63add34abe54310145bcc92c521cd2facaa51" # 2023-08-05 13:02
LANG_COMMIT[ja]="e6ad57c396a2e657e0fe3ca70024c405ba49cf8c" # 2023-10-09 16:58
LANG_COMMIT[ja-JP-mac]="4b37b7c4ec604298517860d0592400d37fda3178" # 2023-10-09 16:58
LANG_COMMIT[ka]="a1fa361d1b5dd5f911907fed691b18e0710e034a" # 2023-10-13 06:33
LANG_COMMIT[kab]="0ca67663d182cf7a2095da9a4345d9e62f08622e" # 2023-10-02 16:47
LANG_COMMIT[kk]="fca2b3d9f1ff880d26afbec06b07409dacb81e99" # 2023-10-11 03:05
LANG_COMMIT[km]="32cdc60bd84b8bb6249145e70b5c8fdcb39ac99c" # 2023-09-06 08:13
LANG_COMMIT[kn]="21e68a00b723aa2c3cb8ea311de84ce9ecf06cd4" # 2023-09-06 08:13
LANG_COMMIT[ko]="bc3e11d81961f39ed881baf680a246e6ae814baa" # 2023-10-10 05:14
LANG_COMMIT[kok]="03d30f64e3129773b19bdcbfa1221fee291eacb0" # 2023-08-31 09:03
LANG_COMMIT[ks]="1c0d2d21690e34ddda3ac38936afea1114810c29" # 2023-08-31 09:03
LANG_COMMIT[ku]="28f3f434402c56a2f88b4b2394b0e78fe64777ec" # 2023-08-31 09:03
LANG_COMMIT[lb]="41d29f28adcf308a4cf53496c83d52abc3479cd3" # 2023-08-05 13:04
LANG_COMMIT[lg]="3359cb1deca24ec873ee035096c78c3e49a9b706" # 2023-08-31 09:03
LANG_COMMIT[lij]="6c87f8c5c62e65fb78fd1306f1dd2843860cfca8" # 2023-10-02 16:48
LANG_COMMIT[lo]="df983724e2434e5261e1f9e3837a5b7bbbc52aba" # 2023-10-02 16:48
LANG_COMMIT[lt]="8b66dc10100c650485e54f67e9eb6ae16bea233d" # 2023-10-02 16:48
LANG_COMMIT[ltg]="18c348aaaef82ad9ec6909e4179d5536a81c88d6" # 2023-09-06 08:14
LANG_COMMIT[lv]="4b9764ab19238981cb23f350fa359f83aeceaf11" # 2023-09-06 08:14
LANG_COMMIT[mai]="92503138ae7d2d0168d3a38aa2a81a8c4f832e37" # 2023-09-06 08:15
LANG_COMMIT[meh]="9394366f2476e1179e47db739466882c3dcc142b" # 2023-10-02 16:48
LANG_COMMIT[mix]="029f864e4d638d25f3896424fa918400f6ecfd68" # 2023-08-05 13:06
LANG_COMMIT[mk]="2c5f0467143b861ee8af5062e0799598517f7e63" # 2023-09-06 08:15
LANG_COMMIT[ml]="c4f2be9c93b28aa46f130c948f262affcfeb603c" # 2023-09-06 08:15
LANG_COMMIT[mn]="ed7446396111ce4dcc3b26281e96bf51b9d29b1e" # 2023-08-31 09:05
LANG_COMMIT[mr]="f7a64cf23cfc5f8fb69cf959efd25bc074d95bfb" # 2023-10-02 16:49
LANG_COMMIT[ms]="41c914afd75d0ae556ce79e6093c362ce9e20eba" # 2023-09-06 08:16
LANG_COMMIT[my]="92272ec0b76c784be3491ce380f993e8e0b92759" # 2023-09-06 08:18
LANG_COMMIT[nb-NO]="a11bd2fd39e4274380635bcf0dac4684c457d420" # 2023-10-11 11:36
LANG_COMMIT[ne-NP]="08dafca366c75df8c665b0689c4082eee1bb969e" # 2023-09-06 08:20
LANG_COMMIT[nl]="8c8d142b555b5d91943c409df6aa080b019c9c64" # 2023-10-10 13:05
LANG_COMMIT[nn-NO]="197abc4fac9566518e45a7c3ed42603ec82b9928" # 2023-10-12 21:54
LANG_COMMIT[nr]="573a9aa6c19c5e2e9937d7a0f537d8dbecc354d7" # 2023-08-05 13:08
LANG_COMMIT[nso]="937d05cb2d65b745277abdaa082a76ebf53daf82" # 2023-08-31 09:06
LANG_COMMIT[ny]="a582f27b50425c1658edb438616cc15349bffe12" # 2023-08-05 13:09
LANG_COMMIT[oc]="69372c47468b9b4217c1824034fee43de6394ce2" # 2023-10-12 16:33
LANG_COMMIT[or]="4c3e242ba7298c0e5d31711067267562abcb56be" # 2023-08-31 09:06
LANG_COMMIT[pa-IN]="b271804846e323fc7c5ea4689158f58f0a03ad68" # 2023-10-12 13:34
LANG_COMMIT[pai]="49fd654beb254c472f5785d6cffcbccf6970100f" # 2023-08-05 13:09
LANG_COMMIT[pbb]="5aee05c05a1a54bdd9dee291e47e8217bb484c13" # 2023-08-31 09:06
LANG_COMMIT[pl]="77f71acafd7cd1b56135c4cbfb749e4b2ae69271" # 2023-10-09 17:00
LANG_COMMIT[pt-BR]="e7fb94ac0808d5ba8ee356506798dc1f0aa763d6" # 2023-10-10 16:54
LANG_COMMIT[pt-PT]="b7aea149689642d10c457618991ec5cc66a4aece" # 2023-10-09 17:01
LANG_COMMIT[rm]="d73e3a68664a075321a9bd552ea87e993ce8903d" # 2023-10-13 14:34
LANG_COMMIT[ro]="bfef6ff21f1ae44d40811aba7bb449ed76a07ef1" # 2023-10-02 16:50
LANG_COMMIT[ru]="51b0860e4e71841886c541780beb4cd4c810d7f5" # 2023-10-10 19:53
LANG_COMMIT[rw]="6334f98efbcc81e44963ad5d18012437e1c4d843" # 2023-08-05 13:11
LANG_COMMIT[sah]="1a15a2d771a38dd90c2b75642c9145ed73367223" # 2023-08-31 09:07
LANG_COMMIT[sat]="46c8189e9299a1d53fa3c04a0bb804a02010747b" # 2023-10-09 17:01
LANG_COMMIT[sc]="64c1c751beb287130354f3a0d0c83b3b2ff85802" # 2023-10-09 17:01
LANG_COMMIT[scn]="ce5ef15662bb449b0153a4ff1e662c4a7819f3cb" # 2023-08-31 09:08
LANG_COMMIT[sco]="0287d1888da0b92995de37ffa868a9707eae2358" # 2023-10-02 16:51
LANG_COMMIT[si]="a2d1c1af5d8fb411077d0d939853eac58bc2b7c2" # 2023-10-04 22:34
LANG_COMMIT[sk]="f84cd60575f1414124959f8edfdcbca42eda6e74" # 2023-10-10 19:34
LANG_COMMIT[sl]="b81b73faa2bf313d96d1cc2473f3e0d52e1ff2c8" # 2023-10-11 10:23
LANG_COMMIT[son]="4f79674b0eed472b22b30ae969181c8d31730a15" # 2023-09-06 08:29
LANG_COMMIT[sq]="8ef8e49d328652ee3929e9c6d0d50e21a8641e5f" # 2023-10-02 16:51
LANG_COMMIT[sr]="fb2297eed573cd88c6f88d2464a6db1d86d5d4a4" # 2023-10-02 16:51
LANG_COMMIT[ss]="bec601c8a508d164142f9ae085ae2aba16904bab" # 2023-08-05 13:14
LANG_COMMIT[st]="482adc426c35bac5a6331ef80f5d5b7463ce5996" # 2023-08-05 13:14
LANG_COMMIT[sv-SE]="dc563f48250095c6e608e6e12e7b39f942b4184f" # 2023-10-10 23:13
LANG_COMMIT[sw]="9982a17775b727260a02c7da10824da2096c551b" # 2023-08-31 09:09
LANG_COMMIT[szl]="4460fd42f7d4919ca745cc159aa04f8743a3788d" # 2023-10-02 16:52
LANG_COMMIT[ta]="22996f0cf56166d62bb14cafea1f31aba07ab9a6" # 2023-09-06 08:30
LANG_COMMIT[ta-LK]="ac7ce62f1f0bf551114afaf491214679a09553e4" # 2023-08-05 13:15
LANG_COMMIT[te]="82620cdd59e41a1b7ea0fe23b782f0735879dfb3" # 2023-10-02 16:52
LANG_COMMIT[tg]="5424b2f596b3f321e3d50b7a26ca5a8a421f5b35" # 2023-10-13 04:54
LANG_COMMIT[th]="bd39c196d7d9592c71ab16751bc8b6c79856082c" # 2023-10-13 21:43
LANG_COMMIT[tl]="4260a1de427fdd1b944cf1330a4220be617b8c75" # 2023-10-02 16:52
LANG_COMMIT[tn]="c6567884d8d7861284a8a65a1a2b7ba6add30db2" # 2023-08-05 13:16
LANG_COMMIT[tr]="a8c72eb518d89ee682aa8a62b144f41152499480" # 2023-10-10 19:35
LANG_COMMIT[trs]="a97ff76c710629bf93da923fdd2a08e366df50b5" # 2023-10-02 16:52
LANG_COMMIT[ts]="0b2b6bbabc55009bef8396206d7077268542d677" # 2023-08-05 13:17
LANG_COMMIT[tsz]="21ce74482b1e6921e7a324d4ae8c664e45342a57" # 2023-08-05 13:17
LANG_COMMIT[uk]="152c6434a354efd703169a942217d0e7ad40d7fa" # 2023-10-09 17:03
LANG_COMMIT[ur]="c4b5a08f91f439f842cf34b2744a5d27fa8994ec" # 2023-10-02 16:52
LANG_COMMIT[uz]="42ace9dab9a05794e34053ce3355b3be0daa712f" # 2023-09-06 08:31
LANG_COMMIT[ve]="3bbc59de131df9e5d7462bf6f09231056eb5a5ed" # 2023-08-05 13:18
LANG_COMMIT[vi]="6c482f2fd33b1d3fb5c9cfe67a22119247c52696" # 2023-10-11 16:23
LANG_COMMIT[wo]="e485ae738ab0c90e47d33320629c6195baf791a8" # 2023-08-31 09:11
LANG_COMMIT[xcl]="d8594b93e5b9b7ff6e024cbb399caa6fe19544f8" # 2023-07-06 08:54
LANG_COMMIT[xh]="d2e7cd713daaa3c681d79342bbdb798b21dcdab7" # 2023-08-31 09:12
LANG_COMMIT[zam]="019fabc6db58bed3ad2f6b9a3fdb93f38817c9da" # 2023-08-05 13:19
LANG_COMMIT[zh-CN]="853659d756844d448d6da1b57ec8e2055bae96d1" # 2023-10-12 17:10
LANG_COMMIT[zh-TW]="01eac9796780092fdd37978e29a5cd1788aef160" # 2023-10-12 04:43
LANG_COMMIT[zu]="b796166454b4c4f0dfa67f3b32b66277f703ebc5" # 2023-08-31 09:12

fetch_l10n() {
	local lang
	for lang in "${!LANG_COMMIT[@]}" ; do
		#en_US is handled internally
		if [[ ${lang} == en-US ]] ; then
			continue
		fi
		SRC_URI+=" https://hg.mozilla.org/l10n-central/${lang}/archive/${LANG_COMMIT[${lang}]}.zip -> icecat-lang-${lang}-${LANG_COMMIT[${lang}]}.zip"
	done
}
fetch_l10n

python_check_deps() {
	python_has_version "dev-python/jsonschema[${PYTHON_USEDEP}]"
}

src_unpack() {
	unpack "gnuzilla-${COMMIT}.tar.gz"
	for langpack in $(cd "${DISTDIR}"; ls icecat-lang-*.zip); do
		unpack ${langpack}
	done
	unpack "compare-locales-${COMPARE_LOCALES_PV}.tar.gz"
}

src_prepare() {
	default_src_prepare

	# Remove the minimum necessary for script to work offline
	sed -i '/^verify_sources$/d' makeicecat || die
	sed -i '/hg checkout ${L10N_CMP_REV}$/d' makeicecat || die

	# brand.dtd's removed in l10n's
	sed -i -e '/find l10n.*brand.dtd/d' makeicecat || die

	mkdir "${S}/output" || die
	cp "${DISTDIR}/firefox-${PV}esr.source.tar.xz" "${S}/output" || die

	mkdir "${S}/output/l10n" || die
	for lang in "${!LANG_COMMIT[@]}"; do
		#en_US is handled internally
		if [[ ${lang} == en-US ]] ; then
			continue
		fi
		mv "${WORKDIR}/${lang}-${LANG_COMMIT[${lang}]}" "${S}/output/l10n/${lang}" || die
		mkdir -p "${S}/output/l10n/${lang}/browser/chrome/browser/preferences" || die
		touch "${S}/output/l10n/${lang}/browser/chrome/browser/preferences//advanced-scripts.dtd" || die
		rm -rf "${S}/output/l10n/${lang}/.hg*" || die
	done
	mv "${WORKDIR}/compare-locales-RELEASE_${COMPARE_LOCALES_PV//./_}" "${S}/output/compare-locales" || die
}

src_compile() {
	if use buildtarball; then
		./makeicecat || die
	fi
}

src_install() {
	insinto "/usr/src/makeicecat-${PV}"
	doins -r "${S}/"{artwork,CHANGELOG,COPYING,data,makeicecat,README,tools}
	fperms +x "/usr/src/makeicecat-${PV}"/{makeicecat,tools/{AddonsScraper.py,buildbinaries,createdebsrcrepo,gnupload}}
	if use buildtarball; then
		insinto /usr/src/makeicecat-"${PV}"/output
		doins "${S}/output/icecat-${PV}-gnu1.tar.bz2"
	fi
}

pkg_postinst() {
	if ! use buildtarball; then
		einfo "You haven't enabled buildtarball, therefore you have to create the tarball yourself."
		einfo "You can create the tarball in /usr/share/makeicecat-${PV} by starting the script manually."
		einfo "   ./makeicecat"
		einfo "It will take a while so be prepared."
	fi
}
