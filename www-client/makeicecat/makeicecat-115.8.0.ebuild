# Copyright 2021-2024 Gentoo Authors
# Distributed under the terms of the GNU General Public License v2

EAPI=8

PYTHON_COMPAT=( python3_{10..12} )

inherit python-any-r1

DESCRIPTION="Script for creating GNU Icecat tarball"
HOMEPAGE="https://www.gnu.org/software/gnuzilla/"

COMMIT="7e2ff1ad7e03d2bfe0b2daf3f25961b06cab8848"
COMPARE_LOCALES_PV="9.0.1"
SRC_URI="
	https://git.savannah.gnu.org/cgit/gnuzilla.git/snapshot/gnuzilla-${COMMIT}.tar.gz
	https://archive.mozilla.org/pub/firefox/releases/${PV}esr/source/firefox-${PV}esr.source.tar.xz
	https://github.com/mozilla/compare-locales/archive/refs/tags/RELEASE_${COMPARE_LOCALES_PV//./_}.tar.gz
		-> compare-locales-${COMPARE_LOCALES_PV}.tar.gz
"

LICENSE="GPL-3"
SLOT="${PV}"
KEYWORDS="~amd64"

RESTRICT="test mirror"

IUSE="+buildtarball"

RDEPEND="${BDEPEND}"
BDEPEND="
	${PYTHON_DEPS}
	app-arch/unzip
	app-crypt/gnupg
	dev-vcs/mercurial
	$(python_gen_any_dep '
		dev-python/jsonschema[${PYTHON_USEDEP}]
	')
"

S="${WORKDIR}/gnuzilla-${COMMIT}"

declare -A LANG_COMMIT

LANG_COMMIT[ace]="203b742e48bb986ada172d0b16112ebf705ca3e2" # 2023-12-18 12:43
LANG_COMMIT[ach]="31cafce0d6a6b3b2a3f696aaf08ec722012b3be4" # 2023-12-18 12:43
LANG_COMMIT[af]="f75b56616bce86d35d7224d5d92a619184ad20e3" # 2023-12-18 12:44
LANG_COMMIT[ak]="b59d826d36120389d874ddfa05a025c235895298" # 2023-12-18 12:44
LANG_COMMIT[an]="170c9c82f5c0c8f0229c2493903628f1c0b39f89" # 2023-12-18 12:44
LANG_COMMIT[ar]="07b94b407ac6f111e3f0460c87f5933323c91b41" # 2023-12-18 12:44
LANG_COMMIT[as]="abee7df5682183a4448c4267e08bf04011843de8" # 2023-12-24 07:43
LANG_COMMIT[ast]="64e0c51ec3b5b947743ed79b4481ce26f32fc5ad" # 2023-12-18 12:44
LANG_COMMIT[az]="c4936b362cd8f5743fa939b65fc4e1c3bec5e3ae" # 2023-12-18 12:44
LANG_COMMIT[be]="2da269a4cdc20f5669c0ddd0e27e1b231e3727e1" # 2023-12-24 20:13
LANG_COMMIT[bg]="f1938112751575e54826c4b6e197c6c27f5fe23d" # 2023-12-20 08:23
LANG_COMMIT[bn]="a70dde67a6393c1b775fcab73779695c396e9394" # 2023-12-18 12:44
LANG_COMMIT[bn-BD]="87780662471b9a0f46906ef82cf0f7ad8fbf5b1f" # 2023-12-18 12:44
LANG_COMMIT[bn-IN]="1b2e79b7fdf4f09178983829e0430c462dbcd8aa" # 2023-12-18 12:44
LANG_COMMIT[bo]="009c041899a30a0d1fa8d94ec3e4c8819e77a79d" # 2023-12-18 12:45
LANG_COMMIT[br]="47dead449fda047feb8ad3ceee2f4b87abbe6023" # 2023-12-24 12:22
LANG_COMMIT[brx]="fcd8dc671b6c63f3b006f28a5f61079fa0aae122" # 2023-12-18 12:45
LANG_COMMIT[bs]="c6776a1e3362a4bdc3e539eea07acd0ac323a714" # 2023-12-19 10:22
LANG_COMMIT[ca]="5087af2878c96a814aec53fdf84b3c9cb7c16cf9" # 2023-12-18 12:45
LANG_COMMIT[ca-valencia]="4e5940867a5b05eb6e22681273e9a409319fdd7e" # 2023-12-18 12:45
LANG_COMMIT[cak]="433a9a791b8f2539b6762d068ef08f17642fe565" # 2023-12-18 12:45
LANG_COMMIT[ckb]="4d0f2adc9dab36debe087c98df46ab9d63a60e4c" # 2023-12-18 12:45
LANG_COMMIT[crh]="3eb9fa5d7cb23b266cce2b2eae6d5ee9dd8c3f67" # 2023-12-18 12:45
LANG_COMMIT[cs]="c082dea86e05c66bbad11d8923a58367ecfcd0c8" # 2023-12-20 20:52
LANG_COMMIT[csb]="2309fb43aa3cf93c50dc61bd1e7b42e0a14c0c89" # 2023-12-18 12:45
LANG_COMMIT[cy]="1fb5776dc04db6663fc4352a60aa6963acb3e949" # 2023-12-21 11:47
LANG_COMMIT[da]="becedd06cb3f0b8d0329aff553bc64f900f45d62" # 2023-12-20 10:53
LANG_COMMIT[de]="eca8692523dab1cbeafa0e8a89c28bf5eb22834f" # 2023-12-20 08:33
LANG_COMMIT[dsb]="7c176d22743c504a343ad7005101a096a75f9a53" # 2023-12-18 22:53
LANG_COMMIT[el]="1e9195f7fae2cf569fc1e08d0840a388b6bf752c" # 2023-12-20 11:33
LANG_COMMIT[en-CA]="eff1925ec383811c59a9a223a8b181f3021bd952" # 2023-12-18 12:46
LANG_COMMIT[en-GB]="dc74e01114f29e3d69c6fafb12a430132043dc3f" # 2023-12-19 14:50
LANG_COMMIT[en-ZA]="f500719ee015d14b872cb02ce870f4a2571bd0a7" # 2023-12-18 12:46
LANG_COMMIT[eo]="eac94f6da44ddd9fd9c77838c9bb9aa1f1148cde" # 2023-12-18 12:46
LANG_COMMIT[es-AR]="3861f044ff807dd66d908d4c877802cdccc66ac8" # 2023-12-19 06:04
LANG_COMMIT[es-CL]="890127fa967d455ead69b4048ef83c913894256f" # 2023-12-19 23:23
LANG_COMMIT[es-ES]="6ba419ddc1bc7a5fb619820d13a3f0bd1ff2f203" # 2023-12-18 12:46
LANG_COMMIT[es-MX]="a7573f342823d343a737a91399d930a7a9a6c7d1" # 2023-12-18 12:47
LANG_COMMIT[et]="4814689c0503a49fb3feb2791c81e38c4a1ed336" # 2023-12-18 12:47
LANG_COMMIT[eu]="8094b090318e7d146ec5143d5d0572e6b5ad64de" # 2023-12-18 12:47
LANG_COMMIT[fa]="26faed719830a2e58ca2e87c01421ae4bd795c01" # 2023-12-18 12:47
LANG_COMMIT[ff]="8aa0163484b63de09a7f63e206823de618074678" # 2023-12-18 12:47
LANG_COMMIT[fi]="633ba8876d0fdac1b679a5a5e09ce6bbc44e64ea" # 2023-12-21 21:42
LANG_COMMIT[fr]="a31cf6428e3dded63188087fbf5c30c4be7e1efc" # 2023-12-21 10:44
LANG_COMMIT[frp]="44166b1dc0ab817f45f4961b1d05d2220d9e43d9" # 2023-10-24 10:07
LANG_COMMIT[fur]="436f46bce45617ed9eca7e5b0065e2107eeb6077" # 2023-12-23 10:52
LANG_COMMIT[fy-NL]="614d09c70056ed84c4b09450cde47f40d49ddc6b" # 2023-12-19 10:03
LANG_COMMIT[ga-IE]="d271f275cf48a006acf046519793dde34bd0fbeb" # 2023-12-18 12:47
LANG_COMMIT[gd]="35d9f5c851153d1483ed3b42a7645e35d7c1c6cd" # 2023-12-18 12:47
LANG_COMMIT[gl]="dc30d9ab9804576f5eead8435a7a4fdbcf24f402" # 2023-12-18 12:48
LANG_COMMIT[gn]="f900b49b4752dad33deb97a9ad9cf3beb8992e69" # 2023-12-23 05:35
LANG_COMMIT[gu-IN]="99d824aecee2c4d7dc26854d6b9d85319516ac1a" # 2023-12-18 12:48
LANG_COMMIT[gv]="025c6cac9fe0191b1713087655945a0554d3a69f" # 2023-07-06 08:39
LANG_COMMIT[he]="b9f8d0d6e7aab304df2f2ab8697bcfdc92a546ef" # 2023-12-19 00:04
LANG_COMMIT[hi-IN]="5f5a4a745ab4666e49407b48b01257413cab2962" # 2023-12-18 12:48
LANG_COMMIT[hr]="dbf0c647b2e6cca7408661476453cf31cfd7fa3c" # 2023-12-18 12:48
LANG_COMMIT[hsb]="b0c2d601289fc4786e9e5b9e2e01038fd373353c" # 2023-12-20 11:23
LANG_COMMIT[hto]="a59d3abb9c1d53c10988660c020e0f54fd094d78" # 2023-12-18 12:48
LANG_COMMIT[hu]="287296b8ee4d77c822c8fc1ca00a5481c14a110e" # 2023-12-21 17:42
LANG_COMMIT[hy-AM]="d7f3ec7a73524d940ef57fa9566e011b139d2389" # 2023-12-18 12:48
LANG_COMMIT[hye]="0b9225b47f6ae70bc718356c633a228a9d1725d8" # 2023-12-18 12:48
LANG_COMMIT[ia]="012e30510e31422436a68ef7c9187260e93ceea0" # 2023-12-21 16:42
LANG_COMMIT[id]="0735dad19f9c5712eb6dadbd0332aed985ee3205" # 2023-12-18 12:49
LANG_COMMIT[ilo]="bf48be93bd269541e7f16bb0db448188aef69a4c" # 2023-12-06 11:24
LANG_COMMIT[is]="42f8f5ac6e6c629076539a5793230cd5117eab2c" # 2023-12-24 12:03
LANG_COMMIT[it]="7e8ac9e00235944d40f109937bb7bde3de8480d6" # 2023-12-21 07:49
LANG_COMMIT[ixl]="a427d90096645e34e7d217dca8bef4f8fe4b8c64" # 2023-12-18 12:49
LANG_COMMIT[ja]="5ca58a548615023d978598e9c5f067efb648f25a" # 2023-12-18 12:49
LANG_COMMIT[ja-JP-mac]="a707dead01dad034a3f6455f92c3de74b82556ee" # 2023-12-18 12:49
LANG_COMMIT[ka]="bc012acb5b9dc2a7c4049acaae5d948583ef95cf" # 2023-12-23 23:23
LANG_COMMIT[kab]="1bb0fbcf70e08c506049ea1a0c0636b19343f22d" # 2023-12-18 12:49
LANG_COMMIT[kk]="05fbeacdaa498f5da086fb253f1d622b069a5e02" # 2023-12-22 17:04
LANG_COMMIT[km]="006435264ce37b6daf75558316730614936ce5e8" # 2023-12-18 12:50
LANG_COMMIT[kn]="2bd68cc25a04fe321dac1ad6fa102c1424976e8f" # 2023-12-18 12:50
LANG_COMMIT[ko]="0857b1ac57de55788d7846917027188963d10181" # 2023-12-20 04:22
LANG_COMMIT[kok]="737b4030830cbc8b383b09915a49e4ce5cc9084c" # 2023-12-18 12:50
LANG_COMMIT[ks]="dd7309a7ddbafb807a1dd9cbc4e44fb9064b326b" # 2023-12-18 12:50
LANG_COMMIT[ku]="5e4af42a73260024f47959b6a18df03b72f6d6eb" # 2023-12-18 12:50
LANG_COMMIT[lb]="1a4d42a67150f7bd7cea912092119e251840f997" # 2023-12-18 12:50
LANG_COMMIT[lg]="c6ae1d30b483776e190b90da1361f9b88421751e" # 2023-12-18 12:50
LANG_COMMIT[lij]="80f5515a87a3bcf8249b094ea80778afa5bc85d1" # 2023-12-18 12:50
LANG_COMMIT[lo]="800965d38934682cbe3c8298ee3570ff1f2c8490" # 2023-12-19 18:43
LANG_COMMIT[lt]="9af3d5f38ed861ff3891da0369b9b358e3c74e8e" # 2023-12-18 12:50
LANG_COMMIT[ltg]="5d943cb6a7bb1969062a07fde7240c14e0169d35" # 2023-12-18 12:50
LANG_COMMIT[lv]="962cebf07407a8bfb5d557471c26b0fe593f2b23" # 2023-12-18 12:50
LANG_COMMIT[mai]="b4fa33a15c3425a13fd8e9b29c6b5e5287b81669" # 2023-12-18 12:51
LANG_COMMIT[meh]="750c5245632e0c560be23642526e9db5351d590e" # 2023-12-18 12:51
LANG_COMMIT[mix]="e4c8e957f2dae2ec2627482322d11d7bd4bce0e0" # 2023-12-18 12:51
LANG_COMMIT[mk]="fbef80de5499995a75db64bf06903e16f22dee4e" # 2023-12-18 12:51
LANG_COMMIT[ml]="4afcca96aec17a58844219d6bcfe99e103d692f5" # 2023-12-18 12:51
LANG_COMMIT[mn]="444c3a9da0048c43258ea78dec842680ad24e7c1" # 2023-12-18 12:51
LANG_COMMIT[mr]="8ed4566f3c654c7f06a8b628cdccd787ed7cd88f" # 2023-12-18 12:51
LANG_COMMIT[ms]="f059d9d52a8430962d77be89f8414cdf8f977542" # 2023-12-18 12:51
LANG_COMMIT[my]="8b91b825c7a583533e79504e5ed35946aa144fb5" # 2023-12-18 12:51
LANG_COMMIT[nb-NO]="b71bb44d1ac10aeb343bdce2645246f0d086c3f6" # 2023-12-19 23:23
LANG_COMMIT[ne-NP]="d9a123de3015e677d35e9e8f977219f366d7d105" # 2023-12-18 12:51
LANG_COMMIT[nl]="61a1a72fd12cc45f112d88224690841b84ef010d" # 2023-12-19 08:12
LANG_COMMIT[nn-NO]="6fd2cfaf0bf63d186ba981ca27d6beddd762c658" # 2023-12-18 12:52
LANG_COMMIT[nr]="98541817c7f0797cf4fe20b6efa120b17643f394" # 2023-12-18 12:52
LANG_COMMIT[nso]="4d31d6b540210f6fafb9d039bf775787ec170b55" # 2023-12-18 12:52
LANG_COMMIT[ny]="a582f27b50425c1658edb438616cc15349bffe12" # 2023-08-05 13:09
LANG_COMMIT[oc]="c927f87e957607a6c7c1f31b9811d5cc3fbe09fc" # 2023-12-18 12:52
LANG_COMMIT[or]="72601fef28ff763616b70c9bd09f5064cd8561ff" # 2023-12-18 12:52
LANG_COMMIT[pa-IN]="b8a5a464a45f47b1e07b92b6848f0728e129da40" # 2023-12-19 22:33
LANG_COMMIT[pai]="9e771a5c37921a8c97493a83f06cb0a08ddbf48a" # 2023-12-18 12:52
LANG_COMMIT[pbb]="abe11fb1e18b0cc09562ed206d5675006b60e7e0" # 2023-12-18 12:52
LANG_COMMIT[pl]="03dcbd3557e7d642a3375a8458929d5ce799f757" # 2023-12-18 12:52
LANG_COMMIT[pt-BR]="f157cbec4e5040cae8a7d0bf3ea4b2788ffa15f0" # 2023-12-20 03:13
LANG_COMMIT[pt-PT]="a953a1bc54228c6c3c646488dca5c7ae5e5d1610" # 2023-12-18 12:52
LANG_COMMIT[rm]="2ed770e6cf86fd1b3ccfaa25a025dbd1b1a2165d" # 2023-12-18 12:53
LANG_COMMIT[ro]="73431166656d42eeb12ba45f6db757feebaa5548" # 2023-12-18 12:53
LANG_COMMIT[ru]="59e72b65c1fed72c330fe683e2ebceed67965314" # 2023-12-20 08:23
LANG_COMMIT[rw]="aa3fba07626a14b145ee7173faa85a80640c1574" # 2023-12-18 12:53
LANG_COMMIT[sah]="7e8b9d4a721b610c68aee07904d58fc7c5125bf0" # 2023-12-18 12:53
LANG_COMMIT[sat]="34c7893c5c1d22eb3064ea62c5646cbb5e6be980" # 2023-12-18 12:53
LANG_COMMIT[sc]="5053757aa1993015259c423ae9931a50843ce063" # 2023-12-19 18:43
LANG_COMMIT[scn]="2c50b1c5419a6a5c3e08dd0240e6e63f42bf118d" # 2023-12-18 12:53
LANG_COMMIT[sco]="eab7dc10f5490ad784fceabf7633ca170f68c832" # 2023-12-18 12:53
LANG_COMMIT[si]="5bcf1612cc9f5a6538487b5219365ee7fcae4b7b" # 2023-12-18 12:53
LANG_COMMIT[sk]="c126aba528a481ebe2bc8a753527d2c1d937a310" # 2023-12-19 19:43
LANG_COMMIT[sl]="1e862384f97fccc5f4eda233635a2c8db8ad8e47" # 2023-12-21 18:12
LANG_COMMIT[son]="6bf85312780bcff64c8879897ec811a2726d1e43" # 2023-12-18 12:54
LANG_COMMIT[sq]="d5e15ecb0be47a95b90907438c15627bd676f2a9" # 2023-12-18 12:54
LANG_COMMIT[sr]="58a38d27f790ed08e365ad2104e029a16b608bdc" # 2023-12-18 12:54
LANG_COMMIT[ss]="ef16eb485870bfad43f55c1f389a1ad9f59ecc1d" # 2023-12-18 12:54
LANG_COMMIT[st]="9cc6ef31a9cee923e1a89c657caa8d55c26be869" # 2023-12-18 12:54
LANG_COMMIT[sv-SE]="05dade37927916f3c8f4584e8edad8c997c375e6" # 2023-12-18 23:23
LANG_COMMIT[sw]="e0a7cbc57f5ce3bdc98eb7cd7d348ba42f333c9a" # 2023-12-18 12:54
LANG_COMMIT[szl]="162913b2f16c13b0844208b8554ba817609f589d" # 2023-12-18 12:54
LANG_COMMIT[ta]="3fdc472fbc3034d416776833a1aee5005e3afb00" # 2023-12-24 17:12
LANG_COMMIT[ta-LK]="bb4a37012b520241e58e7189725c1fc17d758cd2" # 2023-10-24 10:14
LANG_COMMIT[te]="42666d51ccf74a64e8c86519470ce53d0afc3093" # 2023-12-18 12:55
LANG_COMMIT[tg]="60b312b6a174b12cf5a8f9a4473ef4a906226bc9" # 2023-12-24 02:33
LANG_COMMIT[th]="7da200dfdf0703fff998c8870fbddfdf4f04de91" # 2023-12-23 13:32
LANG_COMMIT[tl]="dd7093e967961fe57477280692147df0d2b0860a" # 2023-12-18 12:55
LANG_COMMIT[tn]="81a8498e1ea70291ebbae371930198ea42892ad4" # 2023-12-18 12:55
LANG_COMMIT[tr]="2cf3b576d1edf7dc419789ee45e20fceb7c7ea5f" # 2023-12-22 14:32
LANG_COMMIT[trs]="6fcf8d686203f3f75eeba1a6b56de8d78cb34013" # 2023-12-18 12:55
LANG_COMMIT[ts]="72e68fb50d014a7e9f3871dcd768da5856840b60" # 2023-12-18 12:55
LANG_COMMIT[tsz]="c91eb17aa3ee1489b2500109bb686da3684c7165" # 2023-12-06 11:30
LANG_COMMIT[uk]="6aec1b3236a088450bb043e77033ec5f48cf9a0f" # 2023-12-23 12:33
LANG_COMMIT[ur]="2aa79a176ae6fd9a51c65c72880bd939f5abaf3c" # 2023-12-18 12:56
LANG_COMMIT[uz]="6eee9399633944011a3ebecc45fa0d5de758e81e" # 2023-12-18 12:56
LANG_COMMIT[ve]="2b774de2a6bf7561540eb81a6d12409bfdcdd517" # 2023-12-18 12:56
LANG_COMMIT[vi]="bc6326c318b4726a5d36e97f903cec16419c6be2" # 2023-12-23 16:22
LANG_COMMIT[wo]="7e48e160c07ed939325a8cf52de27c686959d59a" # 2023-12-18 12:56
LANG_COMMIT[xcl]="b17f141714ae968c9fed09a9c620611dcdfc90f0" # 2023-12-06 11:31
LANG_COMMIT[xh]="b0a85e71398518c848ecf0512fa5f7c0afdcfb4c" # 2023-12-18 12:56
LANG_COMMIT[zam]="68e464994ab0d12c1e235c859db21e5029716e40" # 2023-12-18 12:56
LANG_COMMIT[zh-CN]="7dbc8e46c10b6e31db5170facb7599894846e5c8" # 2023-12-25 18:42
LANG_COMMIT[zh-TW]="0c82a655a6714e10873c982688f2bfbdf9b2060f" # 2023-12-19 05:23
LANG_COMMIT[zu]="6d229426928b17c44444907ac53f59118e8f2cb3" # 2023-12-18 12:56

fetch_l10n() {
	local lang
	for lang in "${!LANG_COMMIT[@]}" ; do
		#en_US is handled internally
		if [[ ${lang} == en-US ]] ; then
			continue
		fi
		SRC_URI+=" https://hg.mozilla.org/l10n-central/${lang}/archive/${LANG_COMMIT[${lang}]}.zip -> icecat-lang-${lang}-${LANG_COMMIT[${lang}]}.zip"
	done
}
fetch_l10n

python_check_deps() {
	python_has_version "dev-python/jsonschema[${PYTHON_USEDEP}]"
}

src_unpack() {
	unpack "gnuzilla-${COMMIT}.tar.gz"
	for langpack in $(cd "${DISTDIR}"; ls icecat-lang-*.zip); do
		unpack ${langpack}
	done
	unpack "compare-locales-${COMPARE_LOCALES_PV}.tar.gz"
}

src_prepare() {
	default_src_prepare

	# Remove the minimum necessary for script to work offline
	sed -i '/^verify_sources$/d' makeicecat || die
	sed -i '/hg checkout ${L10N_CMP_REV}$/d' makeicecat || die

	# brand.dtd's removed in l10n's
	sed -i -e '/find l10n.*brand.dtd/d' makeicecat || die

	mkdir "${S}/output" || die
	cp "${DISTDIR}/firefox-${PV}esr.source.tar.xz" "${S}/output" || die

	mkdir "${S}/output/l10n" || die
	for lang in "${!LANG_COMMIT[@]}"; do
		#en_US is handled internally
		if [[ ${lang} == en-US ]] ; then
			continue
		fi
		mv "${WORKDIR}/${lang}-${LANG_COMMIT[${lang}]}" "${S}/output/l10n/${lang}" || die
		mkdir -p "${S}/output/l10n/${lang}/browser/chrome/browser/preferences" || die
		touch "${S}/output/l10n/${lang}/browser/chrome/browser/preferences//advanced-scripts.dtd" || die
		rm -rf "${S}/output/l10n/${lang}/.hg*" || die
	done
	mv "${WORKDIR}/compare-locales-RELEASE_${COMPARE_LOCALES_PV//./_}" "${S}/output/compare-locales" || die
}

src_compile() {
	if use buildtarball; then
		./makeicecat || die
	fi
}

src_install() {
	insinto "/usr/src/makeicecat-${PV}"
	doins -r "${S}/"{artwork,CHANGELOG,COPYING,data,makeicecat,README,tools}
	fperms +x "/usr/src/makeicecat-${PV}"/{makeicecat,tools/{AddonsScraper.py,buildbinaries,createdebsrcrepo,gnupload}}
	if use buildtarball; then
		insinto /usr/src/makeicecat-"${PV}"/output
		doins "${S}/output/icecat-${PV}-gnu1.tar.bz2"
	fi
}

pkg_postinst() {
	if ! use buildtarball; then
		einfo "You haven't enabled buildtarball, therefore you have to create the tarball yourself."
		einfo "You can create the tarball in /usr/share/makeicecat-${PV} by starting the script manually."
		einfo "   ./makeicecat"
		einfo "It will take a while so be prepared."
	fi
}
